# EAFIX Pattern Registry
# Maps operation_kinds to verification patterns with implementation references

version: "1.0"
registry_id: "eafix-pattern-registry"

# ============================================================================
# OPERATION KIND DEFINITIONS
# ============================================================================
operation_kinds:
  # Data Processing Operations
  - id: "data_processing"
    category: "processing"
    description: "General data transformation and processing"
    verification_required: false
    
  - id: "data_transformation"
    category: "processing"
    description: "Data format conversion and normalization"
    verification_required: true
    verification_kind: "VERIFY_STATE_TRANSITIONS"
    
  - id: "data_loading"
    category: "io"
    description: "Loading data from external sources"
    verification_required: false

  # Filesystem Operations
  - id: "filesystem_operation"
    category: "io"
    description: "File read/write operations"
    verification_required: true
    verification_kind: "VERIFY_RESOURCE_HANDLING"
    
  - id: "resource_acquisition"
    category: "io"
    description: "Acquiring system resources (handles, connections)"
    verification_required: true
    verification_kind: "VERIFY_RESOURCE_HANDLING"
    
  - id: "resource_release"
    category: "io"
    description: "Releasing system resources"
    verification_required: true
    verification_kind: "VERIFY_RESOURCE_HANDLING"

  # Configuration Operations
  - id: "config_loading"
    category: "config"
    description: "Loading configuration files"
    verification_required: false
    
  - id: "schema_validation"
    category: "validation"
    description: "Validating data against schemas"
    verification_required: true
    verification_kind: "VERIFY_BOUNDARY_COVERAGE"

  # Signal Operations
  - id: "signal_generation"
    category: "trading"
    description: "Generating trading signals"
    verification_required: true
    verification_kind: "VERIFY_INVARIANT_ASSERTIONS"
    
  - id: "deduplication"
    category: "processing"
    description: "Removing duplicate signals"
    verification_required: false
    
  - id: "id_generation"
    category: "processing"
    description: "Generating unique identifiers"
    verification_required: true
    verification_kind: "VERIFY_INVARIANT_ASSERTIONS"
    
  - id: "event_emission"
    category: "messaging"
    description: "Emitting events to message bus"
    verification_required: false

  # Routing Operations
  - id: "routing_decision"
    category: "routing"
    description: "Making routing decisions based on rules"
    verification_required: false
    
  - id: "calculation"
    category: "processing"
    description: "Numerical calculations"
    verification_required: false

  # Bridge Operations
  - id: "bridge_communication"
    category: "integration"
    description: "Communication with external bridge"
    verification_required: true
    verification_kind: "VERIFY_INTEGRATION_SEAMS"
    
  - id: "response_handling"
    category: "integration"
    description: "Handling external responses"
    verification_required: true
    verification_kind: "VERIFY_ERROR_HANDLING"

  # EA Operations
  - id: "ea_processing"
    category: "ea"
    description: "Expert Advisor general processing"
    verification_required: false
    
  - id: "ea_validation"
    category: "ea"
    description: "EA-side validation"
    verification_required: true
    verification_kind: "VERIFY_STATE_TRANSITIONS"
    
  - id: "ea_response"
    category: "ea"
    description: "EA response generation"
    verification_required: false
    
  - id: "ea_order_execution"
    category: "ea"
    description: "EA order execution"
    verification_required: true
    verification_kind: "VERIFY_INVARIANT_ASSERTIONS"
    
  - id: "ea_trade_management"
    category: "ea"
    description: "EA trade lifecycle management"
    verification_required: false

  # Chain Management
  - id: "chain_management"
    category: "workflow"
    description: "Managing trading chain progression"
    verification_required: true
    verification_kind: "VERIFY_STATE_TRANSITIONS"
    
  - id: "decision_gate"
    category: "workflow"
    description: "Decision point in workflow"
    verification_required: false

  # Health Operations
  - id: "health_monitoring"
    category: "monitoring"
    description: "Health monitoring initialization"
    verification_required: false
    
  - id: "heartbeat_emission"
    category: "monitoring"
    description: "Sending heartbeat signals"
    verification_required: false
    
  - id: "heartbeat_validation"
    category: "monitoring"
    description: "Validating heartbeat responses"
    verification_required: true
    verification_kind: "VERIFY_STATE_TRANSITIONS"

  # Error Handling
  - id: "error_entry"
    category: "error"
    description: "Error handling entry point"
    verification_required: false
    
  - id: "error_handling"
    category: "error"
    description: "Error handling and recovery"
    verification_required: true
    verification_kind: "VERIFY_ERROR_HANDLING"

  # Maintenance Operations
  - id: "maintenance"
    category: "maintenance"
    description: "System maintenance tasks"
    verification_required: false
    
  - id: "shutdown"
    category: "lifecycle"
    description: "Graceful shutdown"
    verification_required: false
    
  - id: "state_persistence"
    category: "persistence"
    description: "Persisting system state"
    verification_required: false

  # Test Operations
  - id: "test_execution"
    category: "testing"
    description: "Test execution entry"
    verification_required: false
    
  - id: "test_case"
    category: "testing"
    description: "Individual test case"
    verification_required: false

  # System Operations
  - id: "system_initialization"
    category: "lifecycle"
    description: "System bootstrap initialization"
    verification_required: false
    
  - id: "timer_initialization"
    category: "lifecycle"
    description: "Timer setup"
    verification_required: false
    
  - id: "cache_update"
    category: "cache"
    description: "Cache updates"
    verification_required: false
    
  - id: "scheduler_trigger"
    category: "scheduling"
    description: "Scheduled task trigger"
    verification_required: false
    
  - id: "continuous_loop"
    category: "workflow"
    description: "Continuous processing loop"
    verification_required: false
    
  - id: "quality_gate"
    category: "quality"
    description: "Quality gate checkpoint"
    verification_required: false

# ============================================================================
# VERIFICATION PATTERN DEFINITIONS (Final 20% Library)
# ============================================================================
verification_patterns:
  - id: "VERIFY_BOUNDARY_COVERAGE"
    doc_id: "VER-001"
    description: "Validates input/output boundary conditions"
    category: "boundary"
    implementation: "dag/patterns/verify_boundary_coverage.py"
    test_template: "dag/patterns/templates/test_boundary.py.j2"
    applies_to:
      - "schema_validation"
      - "config_loading"
    assertions:
      - "all_boundaries_tested"
      - "edge_cases_covered"
      - "null_handling_verified"
    metrics:
      - "boundary_coverage_percent"
      - "edge_case_count"
      
  - id: "VERIFY_STATE_TRANSITIONS"
    doc_id: "VER-002"
    description: "Validates state machine transitions"
    category: "state"
    implementation: "dag/patterns/verify_state_transitions.py"
    test_template: "dag/patterns/templates/test_state.py.j2"
    applies_to:
      - "data_transformation"
      - "ea_validation"
      - "chain_management"
      - "heartbeat_validation"
    assertions:
      - "valid_transitions_only"
      - "terminal_states_reachable"
      - "no_unreachable_states"
    metrics:
      - "state_coverage_percent"
      - "transition_count"
      
  - id: "VERIFY_ERROR_HANDLING"
    doc_id: "VER-003"
    description: "Validates error handling paths"
    category: "error"
    implementation: "dag/patterns/verify_error_handling.py"
    test_template: "dag/patterns/templates/test_error.py.j2"
    applies_to:
      - "response_handling"
      - "error_handling"
    assertions:
      - "all_errors_caught"
      - "errors_logged"
      - "recovery_paths_exist"
    metrics:
      - "error_path_coverage"
      - "error_types_handled"
      
  - id: "VERIFY_INTEGRATION_SEAMS"
    doc_id: "VER-004"
    description: "Validates integration points between components"
    category: "integration"
    implementation: "dag/patterns/verify_integration_seams.py"
    test_template: "dag/patterns/templates/test_integration.py.j2"
    applies_to:
      - "bridge_communication"
    assertions:
      - "contracts_honored"
      - "timeout_handling"
      - "retry_logic_works"
    metrics:
      - "seam_coverage_percent"
      - "contract_violations"
      
  - id: "VERIFY_RESOURCE_HANDLING"
    doc_id: "VER-005"
    description: "Validates resource acquisition and release"
    category: "resource"
    implementation: "dag/patterns/verify_resource_handling.py"
    test_template: "dag/patterns/templates/test_resource.py.j2"
    applies_to:
      - "filesystem_operation"
      - "resource_acquisition"
      - "resource_release"
    assertions:
      - "resources_released"
      - "no_leaks"
      - "graceful_cleanup"
    metrics:
      - "resource_leak_count"
      - "cleanup_success_rate"
      
  - id: "VERIFY_INVARIANT_ASSERTIONS"
    doc_id: "VER-006"
    description: "Validates system invariants hold"
    category: "invariant"
    implementation: "dag/patterns/verify_invariants.py"
    test_template: "dag/patterns/templates/test_invariant.py.j2"
    applies_to:
      - "signal_generation"
      - "id_generation"
      - "ea_order_execution"
    assertions:
      - "invariants_hold"
      - "pre_conditions_met"
      - "post_conditions_met"
    metrics:
      - "invariant_violations"
      - "assertion_count"

  - id: "GENERATE_TEMPORAL_TESTS"
    doc_id: "VER-007"
    description: "Generates time-based verification tests"
    category: "temporal"
    implementation: "dag/patterns/generate_temporal_tests.py"
    test_template: "dag/patterns/templates/test_temporal.py.j2"
    applies_to:
      - "heartbeat_validation"
      - "scheduler_trigger"
    assertions:
      - "timing_constraints_met"
      - "sla_compliance"
      - "timeout_behavior"
    metrics:
      - "sla_adherence_percent"
      - "timing_violations"

  - id: "COMPARE_DOCS_IMPLEMENTATION"
    doc_id: "VER-008"
    description: "Compares documentation to implementation"
    category: "documentation"
    implementation: "dag/patterns/compare_docs.py"
    test_template: "dag/patterns/templates/test_docs.py.j2"
    applies_to: []  # Manual selection
    assertions:
      - "docs_match_code"
      - "apis_documented"
      - "examples_work"
    metrics:
      - "doc_coverage_percent"
      - "stale_doc_count"

# ============================================================================
# PATTERN ROUTING RULES
# ============================================================================
pattern_routing:
  default_pattern: null  # No verification by default
  
  rules:
    - name: "State Change Verification"
      condition: "node.changes_state == true"
      pattern: "VERIFY_STATE_TRANSITIONS"
      priority: 1
      
    - name: "Boundary Validation"
      condition: "node.kind in ['schema_validation', 'validation']"
      pattern: "VERIFY_BOUNDARY_COVERAGE"
      priority: 2
      
    - name: "Integration Point Verification"
      condition: "node.kind in ['bridge_communication', 'external_call']"
      pattern: "VERIFY_INTEGRATION_SEAMS"
      priority: 3
      
    - name: "Error Path Verification"
      condition: "node.kind in ['error_handling', 'response_handling']"
      pattern: "VERIFY_ERROR_HANDLING"
      priority: 4
      
    - name: "Resource Lifecycle Verification"
      condition: "node.kind in ['filesystem_operation', 'resource_acquisition', 'resource_release']"
      pattern: "VERIFY_RESOURCE_HANDLING"
      priority: 5
      
    - name: "Invariant Verification"
      condition: "node.kind in ['signal_generation', 'id_generation', 'ea_order_execution', 'calculation']"
      pattern: "VERIFY_INVARIANT_ASSERTIONS"
      priority: 6
