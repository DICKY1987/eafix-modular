# docs/api/openapi.yaml - Master OpenAPI specification

openapi: 3.0.3
info:
  title: EAFIX Trading System API
  description: |
    Comprehensive API documentation for the EAFIX (Enterprise Algorithmic Forex Intelligence eXchange) trading system.
    
    ## Overview
    EAFIX is a modular, microservices-based trading system that provides:
    - Real-time market data ingestion
    - Technical indicator calculation
    - Signal generation and analysis
    - Risk management and portfolio optimization
    - Automated trade execution
    - Performance monitoring and reporting
    
    ## Authentication
    All API endpoints require JWT authentication. Include the token in the Authorization header:
    ```
    Authorization: Bearer <your-jwt-token>
    ```
    
    ## Rate Limits
    - Standard endpoints: 100 requests/minute
    - High-frequency data endpoints: 1000 requests/minute
    - Admin endpoints: 50 requests/minute
    
    ## Error Handling
    All errors follow a consistent format with HTTP status codes and detailed error messages.
    
  version: 1.0.0
  contact:
    name: EAFIX Support
    email: support@eafix.io
    url: https://docs.eafix.io
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.eafix.io/v1
    description: Production server
  - url: https://staging-api.eafix.io/v1
    description: Staging server
  - url: http://localhost:8000/v1
    description: Local development server

paths:
  # Health and Status Endpoints
  /health:
    get:
      summary: Health check
      description: Returns the health status of the service
      tags: [System]
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ready:
    get:
      summary: Readiness check
      description: Returns whether the service is ready to accept requests
      tags: [System]
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'
        '503':
          description: Service is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /metrics:
    get:
      summary: Prometheus metrics
      description: Returns Prometheus-formatted metrics
      tags: [System]
      responses:
        '200':
          description: Metrics data
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP requests_total Total number of requests
                  # TYPE requests_total counter
                  requests_total{method="GET",status="200"} 1234

  # Data Ingestor Endpoints
  /data/market-data:
    get:
      summary: Get market data
      description: Retrieve real-time or historical market data
      tags: [Market Data]
      security:
        - bearerAuth: []
      parameters:
        - name: symbol
          in: query
          required: true
          schema:
            type: string
            example: EURUSD
          description: Currency pair symbol
        - name: timeframe
          in: query
          schema:
            type: string
            enum: [M1, M5, M15, M30, H1, H4, D1]
            default: M1
          description: Data timeframe
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
          description: Number of data points to return
        - name: start_time
          in: query
          schema:
            type: string
            format: date-time
          description: Start time for historical data (ISO 8601)
        - name: end_time
          in: query
          schema:
            type: string
            format: date-time
          description: End time for historical data (ISO 8601)
      responses:
        '200':
          description: Market data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MarketDataResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      summary: Submit market data
      description: Submit new market data points (for data providers)
      tags: [Market Data]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MarketDataInput'
      responses:
        '201':
          description: Market data accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResponse'
        '400':
          description: Invalid data format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Indicator Engine Endpoints
  /indicators/calculate:
    post:
      summary: Calculate technical indicators
      description: Calculate technical indicators for given market data
      tags: [Technical Analysis]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IndicatorRequest'
      responses:
        '200':
          description: Indicator calculated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndicatorResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /indicators/available:
    get:
      summary: List available indicators
      description: Get list of all available technical indicators
      tags: [Technical Analysis]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of available indicators
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndicatorListResponse'

  # Signal Generator Endpoints
  /signals/generate:
    post:
      summary: Generate trading signal
      description: Generate trading signals based on market data and indicators
      tags: [Signal Generation]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignalRequest'
      responses:
        '200':
          description: Signal generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignalResponse'
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /signals/history:
    get:
      summary: Get signal history
      description: Retrieve historical trading signals
      tags: [Signal Generation]
      security:
        - bearerAuth: []
      parameters:
        - name: symbol
          in: query
          schema:
            type: string
          description: Filter by currency pair
        - name: start_date
          in: query
          schema:
            type: string
            format: date
          description: Start date for signal history
        - name: end_date
          in: query
          schema:
            type: string
            format: date
          description: End date for signal history
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 500
          description: Number of signals to return
      responses:
        '200':
          description: Signal history retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignalHistoryResponse'

  # Risk Management Endpoints
  /risk/assess:
    post:
      summary: Assess trade risk
      description: Assess risk for a proposed trade
      tags: [Risk Management]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RiskAssessmentRequest'
      responses:
        '200':
          description: Risk assessment completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskAssessmentResponse'
        '400':
          description: Invalid assessment parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /risk/limits:
    get:
      summary: Get risk limits
      description: Get current risk limits and settings
      tags: [Risk Management]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Risk limits retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskLimitsResponse'

    put:
      summary: Update risk limits
      description: Update risk management limits and parameters
      tags: [Risk Management]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RiskLimitsUpdate'
      responses:
        '200':
          description: Risk limits updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskLimitsResponse'

  # Trade Execution Endpoints
  /trades/execute:
    post:
      summary: Execute trade
      description: Execute a trade based on approved signal
      tags: [Trade Execution]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TradeExecutionRequest'
      responses:
        '201':
          description: Trade executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TradeExecutionResponse'
        '400':
          description: Invalid trade parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Trade not authorized (risk limits exceeded)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /trades/orders:
    get:
      summary: Get active orders
      description: Retrieve list of active trading orders
      tags: [Trade Execution]
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, filled, partial, cancelled]
          description: Filter by order status
        - name: symbol
          in: query
          schema:
            type: string
          description: Filter by currency pair
      responses:
        '200':
          description: Active orders retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderListResponse'

  /trades/orders/{orderId}:
    get:
      summary: Get order details
      description: Get detailed information about a specific order
      tags: [Trade Execution]
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
          description: Unique order identifier
      responses:
        '200':
          description: Order details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDetailsResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      summary: Cancel order
      description: Cancel an active trading order
      tags: [Trade Execution]
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
          description: Unique order identifier
      responses:
        '200':
          description: Order cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancellationResponse'
        '400':
          description: Order cannot be cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Portfolio Management Endpoints
  /portfolio/summary:
    get:
      summary: Get portfolio summary
      description: Get current portfolio status and performance
      tags: [Portfolio Management]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Portfolio summary retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioSummaryResponse'

  /portfolio/positions:
    get:
      summary: Get open positions
      description: Retrieve all open trading positions
      tags: [Portfolio Management]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Open positions retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionsResponse'

  /portfolio/performance:
    get:
      summary: Get performance metrics
      description: Get detailed portfolio performance analytics
      tags: [Portfolio Management]
      security:
        - bearerAuth: []
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [1d, 1w, 1m, 3m, 6m, 1y, all]
            default: 1m
          description: Performance analysis period
      responses:
        '200':
          description: Performance metrics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerformanceResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # System Schemas
    HealthResponse:
      type: object
      required: [status, service]
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        service:
          type: string
        uptime:
          type: number
          description: Service uptime in seconds
        version:
          type: string
        dependencies:
          type: object
          additionalProperties:
            type: string

    ReadinessResponse:
      type: object
      required: [status, service]
      properties:
        status:
          type: string
          enum: [ready, not_ready]
        service:
          type: string
        checks:
          type: object
          additionalProperties:
            type: boolean

    ErrorResponse:
      type: object
      required: [error, message, timestamp]
      properties:
        error:
          type: string
          description: Error type
        message:
          type: string
          description: Human-readable error message
        timestamp:
          type: string
          format: date-time
        details:
          type: object
          description: Additional error details
        request_id:
          type: string
          description: Unique request identifier for tracking

    # Market Data Schemas
    MarketDataPoint:
      type: object
      required: [symbol, timestamp, bid, ask]
      properties:
        symbol:
          type: string
          example: EURUSD
        timestamp:
          type: string
          format: date-time
        bid:
          type: number
          format: double
          example: 1.0950
        ask:
          type: number
          format: double
          example: 1.0952
        volume:
          type: integer
          minimum: 0
        spread:
          type: number
          format: double
          minimum: 0

    MarketDataInput:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/MarketDataPoint'
        source:
          type: string
          description: Data source identifier

    MarketDataResponse:
      type: object
      required: [data, metadata]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/MarketDataPoint'
        metadata:
          type: object
          properties:
            symbol:
              type: string
            timeframe:
              type: string
            count:
              type: integer
            start_time:
              type: string
              format: date-time
            end_time:
              type: string
              format: date-time

    SubmissionResponse:
      type: object
      required: [accepted, count]
      properties:
        accepted:
          type: boolean
        count:
          type: integer
          description: Number of data points accepted
        errors:
          type: array
          items:
            type: string

    # Technical Analysis Schemas
    IndicatorRequest:
      type: object
      required: [symbol, indicator, data]
      properties:
        symbol:
          type: string
          example: EURUSD
        indicator:
          type: string
          enum: [sma, ema, rsi, macd, bollinger_bands, stochastic]
        period:
          type: integer
          minimum: 1
          maximum: 1000
          default: 14
        data:
          type: array
          items:
            type: number
          description: Price data for calculation
        parameters:
          type: object
          description: Indicator-specific parameters

    IndicatorResponse:
      type: object
      required: [indicator, value, timestamp]
      properties:
        indicator:
          type: string
        value:
          oneOf:
            - type: number
            - type: object
          description: Indicator value (single number or object for complex indicators)
        timestamp:
          type: string
          format: date-time
        confidence:
          type: number
          minimum: 0
          maximum: 1
        metadata:
          type: object
          properties:
            calculation_time_ms:
              type: number
            data_points_used:
              type: integer

    IndicatorListResponse:
      type: object
      required: [indicators]
      properties:
        indicators:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              description:
                type: string
              parameters:
                type: object
              output_type:
                type: string
                enum: [single, multiple]

    # Signal Generation Schemas
    SignalRequest:
      type: object
      required: [symbol, indicators, market_data]
      properties:
        symbol:
          type: string
        indicators:
          type: object
          additionalProperties:
            type: number
        market_data:
          $ref: '#/components/schemas/MarketDataPoint'
        strategy:
          type: string
          description: Strategy identifier
        parameters:
          type: object
          description: Strategy-specific parameters

    SignalResponse:
      type: object
      required: [signal_id, symbol, direction, strength, timestamp]
      properties:
        signal_id:
          type: string
        symbol:
          type: string
        direction:
          type: string
          enum: [BUY, SELL, HOLD]
        strength:
          type: number
          minimum: 0
          maximum: 1
        entry_price:
          type: number
          format: double
        stop_loss:
          type: number
          format: double
        take_profit:
          type: number
          format: double
        confidence:
          type: number
          minimum: 0
          maximum: 1
        timestamp:
          type: string
          format: date-time
        indicators_used:
          type: array
          items:
            type: string
        metadata:
          type: object

    SignalHistoryResponse:
      type: object
      required: [signals, pagination]
      properties:
        signals:
          type: array
          items:
            $ref: '#/components/schemas/SignalResponse'
        pagination:
          type: object
          properties:
            total:
              type: integer
            page:
              type: integer
            limit:
              type: integer
            has_next:
              type: boolean

    # Risk Management Schemas
    RiskAssessmentRequest:
      type: object
      required: [signal, portfolio]
      properties:
        signal:
          $ref: '#/components/schemas/SignalResponse'
        portfolio:
          type: object
          properties:
            balance:
              type: number
              format: double
            equity:
              type: number
              format: double
            margin_used:
              type: number
              format: double
            open_positions:
              type: integer
        risk_parameters:
          type: object
          properties:
            max_risk_per_trade:
              type: number
              minimum: 0
              maximum: 1
            max_portfolio_risk:
              type: number
              minimum: 0
              maximum: 1
            max_positions:
              type: integer

    RiskAssessmentResponse:
      type: object
      required: [approved, risk_score]
      properties:
        approved:
          type: boolean
        risk_score:
          type: number
          minimum: 0
          maximum: 1
        position_size:
          type: number
          format: double
        adjusted_stop_loss:
          type: number
          format: double
        adjusted_take_profit:
          type: number
          format: double
        risk_metrics:
          type: object
          properties:
            value_at_risk:
              type: number
            expected_loss:
              type: number
            reward_risk_ratio:
              type: number
        rejection_reason:
          type: string

    RiskLimitsResponse:
      type: object
      properties:
        max_risk_per_trade:
          type: number
        max_portfolio_risk:
          type: number
        max_positions:
          type: integer
        max_daily_loss:
          type: number
        max_leverage:
          type: number
        allowed_symbols:
          type: array
          items:
            type: string

    RiskLimitsUpdate:
      type: object
      properties:
        max_risk_per_trade:
          type: number
          minimum: 0
          maximum: 1
        max_portfolio_risk:
          type: number
          minimum: 0
          maximum: 1
        max_positions:
          type: integer
          minimum: 1
        max_daily_loss:
          type: number
          minimum: 0
        max_leverage:
          type: number
          minimum: 1

    # Trade Execution Schemas
    TradeExecutionRequest:
      type: object
      required: [signal_id, symbol, direction, volume]
      properties:
        signal_id:
          type: string
        symbol:
          type: string
        direction:
          type: string
          enum: [BUY, SELL]
        volume:
          type: number
          format: double
          minimum: 0.01
        order_type:
          type: string
          enum: [MARKET, LIMIT, STOP]
          default: MARKET
        price:
          type: number
          format: double
          description: Required for LIMIT orders
        stop_loss:
          type: number
          format: double
        take_profit:
          type: number
          format: double
        comment:
          type: string

    TradeExecutionResponse:
      type: object
      required: [order_id, status]
      properties:
        order_id:
          type: string
        status:
          type: string
          enum: [pending, filled, partial, rejected]
        execution_price:
          type: number
          format: double
        execution_time:
          type: string
          format: date-time
        volume_filled:
          type: number
          format: double
        fees:
          type: number
          format: double
        broker_response:
          type: object

    OrderListResponse:
      type: object
      required: [orders]
      properties:
        orders:
          type: array
          items:
            $ref: '#/components/schemas/OrderDetailsResponse'
        total:
          type: integer

    OrderDetailsResponse:
      type: object
      required: [order_id, symbol, direction, volume, status]
      properties:
        order_id:
          type: string
        symbol:
          type: string
        direction:
          type: string
          enum: [BUY, SELL]
        volume:
          type: number
          format: double
        status:
          type: string
          enum: [pending, filled, partial, cancelled]
        order_type:
          type: string
        requested_price:
          type: number
          format: double
        execution_price:
          type: number
          format: double
        created_at:
          type: string
          format: date-time
        filled_at:
          type: string
          format: date-time
        stop_loss:
          type: number
          format: double
        take_profit:
          type: number
          format: double

    CancellationResponse:
      type: object
      required: [order_id, cancelled]
      properties:
        order_id:
          type: string
        cancelled:
          type: boolean
        message:
          type: string

    # Portfolio Management Schemas
    PortfolioSummaryResponse:
      type: object
      required: [balance, equity, margin_used, free_margin]
      properties:
        balance:
          type: number
          format: double
        equity:
          type: number
          format: double
        margin_used:
          type: number
          format: double
        free_margin:
          type: number
          format: double
        margin_level:
          type: number
          format: double
        profit_loss:
          type: number
          format: double
        open_positions:
          type: integer
        daily_pnl:
          type: number
          format: double
        total_trades:
          type: integer
        winning_trades:
          type: integer
        losing_trades:
          type: integer

    PositionsResponse:
      type: object
      required: [positions]
      properties:
        positions:
          type: array
          items:
            type: object
            properties:
              position_id:
                type: string
              symbol:
                type: string
              direction:
                type: string
                enum: [BUY, SELL]
              volume:
                type: number
                format: double
              open_price:
                type: number
                format: double
              current_price:
                type: number
                format: double
              profit_loss:
                type: number
                format: double
              swap:
                type: number
                format: double
              commission:
                type: number
                format: double
              opened_at:
                type: string
                format: date-time
              stop_loss:
                type: number
                format: double
              take_profit:
                type: number
                format: double

    PerformanceResponse:
      type: object
      required: [period, total_return, sharpe_ratio]
      properties:
        period:
          type: string
        total_return:
          type: number
          format: double
        annualized_return:
          type: number
          format: double
        volatility:
          type: number
          format: double
        sharpe_ratio:
          type: number
          format: double
        max_drawdown:
          type: number
          format: double
        win_rate:
          type: number
          format: double
        profit_factor:
          type: number
          format: double
        total_trades:
          type: integer
        avg_trade_duration:
          type: number
          description: Average trade duration in minutes
        monthly_returns:
          type: array
          items:
            type: object
            properties:
              month:
                type: string
                format: date
              return:
                type: number
                format: double

tags:
  - name: System
    description: System health and monitoring endpoints
  - name: Market Data
    description: Market data ingestion and retrieval
  - name: Technical Analysis
    description: Technical indicator calculation
  - name: Signal Generation
    description: Trading signal generation and analysis
  - name: Risk Management
    description: Risk assessment and management
  - name: Trade Execution
    description: Trade execution and order management
  - name: Portfolio Management
    description: Portfolio monitoring and performance analysis